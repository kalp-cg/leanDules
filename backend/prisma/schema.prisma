// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MANAGEMENT ====================

model User {
  id            Int      @id @default(autoincrement())
  isActive      Boolean  @default(true) @map("is_active")
  fullName      String   @map("full_name") @db.VarChar(100)
  email         String   @unique @db.VarChar(100)
  passwordHash  String   @map("password_hash") @db.VarChar(255)
  avatarUrl     String?  @map("avatar_url") @db.Text
  role          String   @default("user") @db.VarChar(20)
  rating        Int      @default(0)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  questions         Question[]
  followers         UserFollower[]     @relation("UserFollowers")
  following         UserFollower[]     @relation("UserFollowing")
  duelsAsPlayer1    Duel[]             @relation("Player1Duels")
  duelsAsPlayer2    Duel[]             @relation("Player2Duels")
  duelAnswers       DuelAnswer[]
  leaderboard       Leaderboard[]
  sessions          Session[]
  refreshTokens     RefreshToken[]
  reports           Report[]
  notifications     Notification[]
  subscriptions     UserSubscription[]

  @@map("users")
}

model UserFollower {
  id          Int      @id @default(autoincrement())
  followerId  Int      @map("follower_id")
  followingId Int      @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp

  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("user_followers")
}

// ==================== CONTENT STRUCTURE ====================

model Category {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  questions Question[]

  @@map("categories")
}

model Difficulty {
  id    Int    @id @default(autoincrement())
  level String @unique @db.VarChar(20)

  questions Question[]

  @@map("difficulties")
}

model Question {
  id           Int      @id @default(autoincrement())
  categoryId   Int      @map("category_id")
  difficultyId Int      @map("difficulty_id")
  questionText String   @map("question_text") @db.Text
  optionA      String   @map("option_a") @db.Text
  optionB      String   @map("option_b") @db.Text
  optionC      String   @map("option_c") @db.Text
  optionD      String   @map("option_d") @db.Text
  correctOption String  @map("correct_option") @db.VarChar(1)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp

  category   Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  difficulty Difficulty     @relation(fields: [difficultyId], references: [id], onDelete: Cascade)
  author     User           @relation(fields: [authorId], references: [id])
  authorId   Int            @map("author_id")
  
  duelQuestions DuelQuestion[]

  @@map("questions")
}

// ==================== DUEL SYSTEM ====================

model Duel {
  id          Int       @id @default(autoincrement())
  player1Id   Int       @map("player1_id")
  player2Id   Int       @map("player2_id")
  winnerId    Int?      @map("winner_id")
  status      String    @default("pending") @db.VarChar(20)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp
  completedAt DateTime? @map("completed_at") @db.Timestamp

  player1       User           @relation("Player1Duels", fields: [player1Id], references: [id], onDelete: Cascade)
  player2       User           @relation("Player2Duels", fields: [player2Id], references: [id], onDelete: Cascade)
  duelQuestions DuelQuestion[]
  duelAnswers   DuelAnswer[]

  @@map("duels")
}

model DuelQuestion {
  id         Int @id @default(autoincrement())
  duelId     Int @map("duel_id")
  questionId Int @map("question_id")

  duel     Duel     @relation(fields: [duelId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("duel_questions")
}

model DuelAnswer {
  id            Int       @id @default(autoincrement())
  duelId        Int       @map("duel_id")
  playerId      Int       @map("player_id")
  questionId    Int       @map("question_id")
  selectedOpt   String    @map("selected_opt") @db.VarChar(1)
  isCorrect     Boolean   @map("is_correct")
  answeredAt    DateTime  @default(now()) @map("answered_at") @db.Timestamp

  duel   Duel @relation(fields: [duelId], references: [id], onDelete: Cascade)
  player User @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@map("duel_answers")
}

// ==================== GAMIFICATION ====================

model Leaderboard {
  id         Int  @id @default(autoincrement())
  userId     Int  @map("user_id")
  totalDuels Int  @default(0) @map("total_duels")
  wins       Int  @default(0)
  rating     Int  @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("leaderboard")
}

// ==================== SUBSCRIPTIONS ====================

model SubscriptionPlan {
  id       Int     @id @default(autoincrement())
  name     String  @db.VarChar(50)
  price    Decimal @db.Decimal(10, 2)
  duration Int
  features String  @db.Text

  subscriptions UserSubscription[]

  @@map("subscription_plans")
}

model UserSubscription {
  id      Int       @id @default(autoincrement())
  userId  Int       @map("user_id")
  planId  Int       @map("plan_id")
  startDate DateTime @map("start_date") @db.Timestamp
  endDate   DateTime @map("end_date") @db.Timestamp

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("user_subscriptions")
}

// ==================== AUTHENTICATION ====================

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique @db.Text
  expiresAt DateTime @map("expires_at") @db.Timestamp
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Session {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  ipAddress  String   @map("ip_address") @db.VarChar(50)
  userAgent  String   @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ==================== MODERATION ====================

model Report {
  id         Int      @id @default(autoincrement())
  reportedId Int      @map("reported_id")
  userId     Int      @map("user_id")
  reason     String   @db.Text
  status     String   @default("pending") @db.VarChar(20)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reports")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}